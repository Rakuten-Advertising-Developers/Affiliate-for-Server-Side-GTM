___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Rakuten Advertising - Affiliate Server-Side",
    "categories": [
    "AFFILIATE_MARKETING"
  ],
  "brand": {
    "id": "github.com_Rakuten-Advertising-Developers",
    "displayName": "Rakuten-Advertising-Developers",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Supports the server side integration of the Rakuten Advertising affiliate tag.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "type",
    "displayName": "Event type",
    "radioItems": [
      {
        "value": "page_view",
        "displayValue": "Pageview"
      },
      {
        "value": "conversion",
        "displayValue": "Conversion"
      },
      {
        "value": "lead",
        "displayValue": "Lead"
      }
    ],
    "simpleValueType": true,
    "defaultValue": "page_view",
    "help": "\u003cb\u003ePageView\u003c/b\u003e - Stores the Rakuten Affiliate URL parameters inside the rmStore cookie\u003cbr\u003e\u003cbr\u003e \u003cb\u003eConversion\u003c/b\u003e - Sends a request with data about the conversion to Rakuten\u003cbr\u003e\u003cbr\u003e \u003cb\u003eLead\u003c/b\u003e - Sends a request with data about the lead/subscription/sign-up to Rakuten"
  },
  {
    "type": "GROUP",
    "name": "conversionGroup",
    "groupStyle": "NO_ZIPPY",
    "subParams": [],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "conversion",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "leadGroup",
    "groupStyle": "NO_ZIPPY",
    "subParams": [],
    "enablingConditions": [
      {
        "paramName": "type",
        "paramValue": "lead",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const encodeUriComponent = require("encodeUriComponent");
const getCookieValues = require("getCookieValues");
const getEventData = require("getEventData");
const getTimestampMillis = require("getTimestampMillis");
const JSON = require("JSON");
const logToConsole = require("logToConsole");
const makeNumber = require("makeNumber");
const makeTableMap = require("makeTableMap");
const Math = require("Math");
const parseUrl = require("parseUrl");
const sendHttpRequest = require("sendHttpRequest");
const setCookie = require("setCookie");

function enc(data) {
    return encodeUriComponent(data || "");
}

//Calculate YYYYMMDD_HHmm from milliseconds timestamp
function isLeapYear(n) {
    const mod4 = n % 4 == 0;
    const mod100 = n % 100 == 0;
    const mod400 = n % 400 == 0;

    return (mod4 && !mod100) || mod400;
}

function getFormattedTime(time_ms) {
    const epoch_20220101 = 1640995200000;
    const time_2022 = time_ms - epoch_20220101;
    const d = 24 * 60 * 60 * 1000;
    const h = 60 * 60 * 1000;
    const m = 60 * 1000;

    const days = Math.floor(time_2022 / d);

    const hour_of_day = Math.floor((time_2022 - days * d) / h);
    const minute_of_day = Math.floor(
        (time_2022 - days * d - hour_of_day * h) / m
    );

    let estimated_year = Math.floor(days / 365) + 2022;

    let days_before_year_minus1 = 0;
    let days_before_year = 0;
    for (let y = 2022; y < estimated_year; y++) {
        days_before_year_minus1 = days_before_year;
        if (isLeapYear(y)) {
            days_before_year += 1;
        }
        days_before_year += 365;
    }

    // sometimes the /365 estimate is a year ahead of itself on new years eve
    if (days_before_year > days) {
        estimated_year--;
        days_before_year = days_before_year_minus1;
    }

    const is_leap_year = isLeapYear(estimated_year);
    const day_of_year = 1 + days - days_before_year;

    const mdn = [
        31, // jan
        28, // feb
        31, // mar
        30, // apr
        31, // may
        30, // jun
        31, // july
        31, // aug
        30, // sep
        31, // oct
        30, // nov
        31, // dec
    ];

    let month_number = -1;
    let n = 0;
    let n1 = 0;

    while (n1 < day_of_year) {
        n = n1;
        n1 += mdn[month_number + 1];
        if (month_number === 0 && is_leap_year) {
            n1++;
        }
        month_number++;
    }

    const day_of_month = day_of_year - n;

    let mm = (month_number + 1).toString();
    if (mm.length === 1) {
        mm = "0" + mm;
    }
    let dd = day_of_month.toString();
    if (dd.length === 1) {
        dd = "0" + dd;
    }
    let hh = hour_of_day.toString();
    if (hh.length === 1) {
        hh = "0" + hh;
    }
    let mi = minute_of_day.toString();
    if (mi.length === 1) {
        mi = "0" + mi;
    }

    return estimated_year.toString() + mm + dd + "_" + hh + mi;
}

// Pageview tag
if (data.type === "page_view") {
    const url = getEventData("page_location");

    if (url) {
        const atrv = parseUrl(url).searchParams.ranSiteID || "";

        if (atrv) {
            const ald = getFormattedTime(getTimestampMillis());
            const rmStore = "ald:" + ald + "|atrv:" + atrv;

            if (rmStore) {
                setCookie(
                    "rmStore",
                    rmStore, {
                        domain: "auto",
                        "max-age": 2592000,
                        path: "/",
                        secure: true,
                        httpOnly: false,
                    },
                    true
                );
            } else if (!rmStore) {
                data.gtmOnFailure();
            }
        } else if (!atrv) {
            data.gtmOnFailure();
        }
    }
    data.gtmOnSuccess();
} else if (data.type === "conversion") {
    // Conversion tag
    // Affiliate config setup
    const affiliateConfig = JSON.parse(getEventData('RAN_affiliate_config')) || '{}';
    // define standard DL variables
    const orderId = getEventData('RAN_transaction_id');
    const currency = getEventData('RAN_currency_code').toUpperCase();
    const customerStatus = getEventData('RAN_customer_status') || '';
    const customerId = getEventData('RAN_customer_id') || '';
    const conversionType = "Sale";
    const discountCode = getEventData('RAN_coupon') || '';
    let discountAmount = getEventData('RAN_discount_amount') || 0;
    let discountAmountLessTax = getEventData('RAN_discount_amount_less_tax') || 0;
    let taxAmount = Math.abs(makeNumber(getEventData('RAN_tax_amount'))) || 0;

    // define standard order level optional data fields;
    const tableData = getEventData('x-ga-mp2-user_properties') || null;
    let optionalDataOrder = null;
    if (tableData) {
        optionalDataOrder = tableData;
    }

    let merchantID = affiliateConfig.ranMID;  
    let allowCommission = true;  
    if (getEventData('RAN_allow_commission') === false || getEventData('RAN_allow_commission') === "false") {
        data.gtmOnFailure();
        return false;
    }
  
    let domain = "track.linksynergy.com";
    if (affiliateConfig.domain) {
        domain = affiliateConfig.domain;
    }
    let trackingMethod = "ep";
    if (affiliateConfig.tagType === "mop") {
        trackingMethod = "eventnvppixel";
    }
    let discountReporting = "item";
    if (affiliateConfig.discountType === "order") {
        discountReporting = "order";
    }
    let includeCustomerStatus = false;
    if (affiliateConfig.includeStatus === true) {
        includeCustomerStatus = true;
    }
    let removeOrderLevelTax = false;
    if (affiliateConfig.removeOrderTax === true) {
        removeOrderLevelTax = true;
    }  
    let removeTaxFromProducts = true;
    if (affiliateConfig.removeTaxFromProducts === false) {
        removeTaxFromProducts = false;
    }
    let removeTaxFromDiscount = false;
    if (affiliateConfig.removeTaxFromDiscount === true) {
        removeTaxFromDiscount = true;
    }
    let useCentValues = true;
    if (affiliateConfig.centValues === false) {
        useCentValues = false;
    }
    const nonCentCurrencies = "JPY";
    let taxRate = affiliateConfig.taxRate || 0;

    // define line items object
    taxRate = Math.abs(makeNumber(taxRate));
    const taxPercent = (100 + taxRate) / 100;

    let lineitems = [];

    //custom_products is used to accomodate non standard ecommerce setups using a custom JS variable  
    if (getEventData('RAN_custom_products')) {
        lineitems = JSON.parse(getEventData('RAN_custom_products'));
    } else {

        let items = getEventData('items');

        for (var i = 0; i < items.length; i++) {
            lineitems.push({
                quantity: items[i].quantity,
                unitPrice: items[i].price,
                unitPriceLessTax: Math.round(makeNumber(items[i].price / taxPercent) * 100) / 100,
                SKU: items[i].sku ||
                    items[i].id ||
                    items[i].item_id ||
                    items[i].SKU ||
                    items[i].ID,
                productName: items[i].name || items[i].item_name,
                optionalData: {
                    cat: items[i].category || items[i].item_category,
                    brand: items[i].brand || items[i].item_brand,
                },
            });
        }
    }
    // define rm_trans object
    const dl = {
        orderid: orderId,
        currency: currency,
        conversionType: conversionType,
        lineitems: lineitems,
    };
  
    // add affiliate config object to rm_trans
    if (affiliateConfig && affiliateConfig.ranMID) {
        dl.affiliateConfig = affiliateConfig;
    }

    // add non-essential data to rm_trans if there is a value for it
    if (customerStatus) {
        dl.customerStatus = customerStatus;
    }
    if (customerId) {
        dl.customerID = customerId;
    }
    if (discountCode) {
        dl.discountCode = discountCode;
    }
    if (discountAmount) {
        dl.discountAmount = discountAmount;
    } else if (discountAmountLessTax) {
        dl.discountAmount =
            Math.round(makeNumber(discountAmountLessTax * taxPercent) * 100) / 100;
    }

    if (discountAmountLessTax) {
        dl.discountAmountLessTax = discountAmountLessTax;
    } else if (discountAmount) {
        dl.discountAmountLessTax =
            Math.round(makeNumber(discountAmount / taxPercent) * 100) / 100;
    }
    if (taxAmount) {
        dl.taxAmount = taxAmount;
    }
    if (taxRate) {
        dl.taxRate = taxRate;
    }
    if (tableData !== null) {
        dl.optionalData = optionalDataOrder;
    }

    let multiplyBy100 = useCentValues && useCentValues !== "false";
    let isNonCentCurrency = false;
    // determine that currency of the order does not have a cent part (e.g JPY)
    if (currency && nonCentCurrencies) {
        let ncc = (nonCentCurrencies + "").split(",");
        for (let index = 0; index < ncc.length; index++) {
            if (ncc[index] == currency) {
                isNonCentCurrency = true;
                break;
            }
        }
    }

    // this function can be used to ensure any money value is being rounded consistently before output.
    // you should not round anything until it is passed into the final string
    const currencyValueToString = function(val) {
        let out = val;
        // non cent currencies only need to return whole integer values
        if (isNonCentCurrency) {
            out = Math.round(val);
        }
        if (multiplyBy100) {
            out = Math.round(val * 100);
        } else {
            out = Math.round(val * 100) / 100;
        }

        // return a rounded value
        return out.toString();
    };

    if (
        !discountAmountLessTax &&
        discountAmount &&
        removeTaxFromDiscount &&
        taxRate
    ) {
        discountAmountLessTax = discountAmount / taxPercent;
    }
    discountAmountLessTax = discountAmountLessTax || discountAmount;

    let skuPrefix = "";
    if (customerStatus) {
        if (
            (includeCustomerStatus && customerStatus.toUpperCase() == "EXISTING") ||
            (includeCustomerStatus && customerStatus.toUpperCase() == "RETURNING")
        ) {
            skuPrefix = "R_";
        }
    }

    if (!dl.orderid && !(dl.lineitems && dl.lineitems.length)) {

        // not enough order data, exit as successfully doing nothing
        data.gtmOnSuccess();
        ///////-----------------------------------------------------------------
        ///////-----------------------------------------------------------------
        ///////---------------------DataLayer is incomplete---------------------
        ///////-----------------------------------------------------------------
        ///////-----------------------------------------------------------------

    } else {
        // have enough order data

        var config = config || dl.affiliateConfig || {};

        const aggregatedLineItems = [];
        let totalSaleValue = 0;

        for (var k = 0; k < (dl.lineitems ? dl.lineitems.length : 0); k++) {
            if (dl.lineitems[k]) {
                let isDuplicateItem = false;
                const item = JSON.parse(JSON.stringify(dl.lineitems[k]));

                const itemQuantity = makeNumber(item.quantity) || 0;
                const itemUnitPrice = makeNumber(item.unitPrice) || 0;
                const itemUnitPriceLessTax = makeNumber(item.unitPriceLessTax);

                let unitPriceLessTax = itemUnitPriceLessTax || itemUnitPrice || 0;
                if (removeTaxFromProducts && taxRate && !itemUnitPriceLessTax) {
                    unitPriceLessTax = unitPriceLessTax / taxPercent;
                }

                const totalLineItemValue = itemQuantity * unitPriceLessTax;

                for (let j = 0; j < aggregatedLineItems.length; j++) {
                    const existing_item = aggregatedLineItems[j];

                    if (existing_item.SKU === item.SKU) {
                        isDuplicateItem = true;
                        existing_item.quantity += itemQuantity;
                        existing_item.totalValue += totalLineItemValue;
                    }
                }

                if (!isDuplicateItem) {
                    item.quantity = itemQuantity;
                    item.totalValue = totalLineItemValue;
                    aggregatedLineItems.push(item);
                }

                totalSaleValue += totalLineItemValue;
            }
        }

        let sku_list = "";
        let quantity_list = "";
        let itemvalue_list = "";
        let name_list = "";
        const optionalDataLineItems = {};

        for (let l = 0; l < aggregatedLineItems.length; l++) {
            const item = aggregatedLineItems[l];

            const itemSKU = enc(item.SKU);
            let itemPrice = item.totalValue;
            const itemQuantity = item.quantity;
            const itemName = enc(item.productName) || "";

            if (discountReporting.toLowerCase() === "item" && discountAmountLessTax) {
                itemPrice =
                    itemPrice - (discountAmountLessTax * itemPrice) / totalSaleValue;
            }

            const od = item.optionalData || {};
            for (const E in od) {
                if (od.hasOwnProperty(E)) {
                    optionalDataLineItems[E] = optionalDataLineItems[E] || "";
                    optionalDataLineItems[E] += enc(od[E]) + "|";
                }
            }

            sku_list += itemSKU + "|";
            quantity_list += itemQuantity + "|";
            itemvalue_list += currencyValueToString(itemPrice) + "|";
            name_list += itemName + "|";
        }

        sku_list = sku_list.slice(0, -1);
        quantity_list = quantity_list.slice(0, -1);
        itemvalue_list = itemvalue_list.slice(0, -1);
        name_list = name_list.slice(0, -1);

        // round discount and tax now as they will not be used in any further calculations.
        if (discountAmountLessTax) {
            discountAmountLessTax = currencyValueToString(discountAmountLessTax);
        }

        if (taxAmount) {
            taxAmount = currencyValueToString(taxAmount);
        }

        if (discountAmountLessTax && discountReporting.toLowerCase() === "order") {
            sku_list += "|" + skuPrefix + "DISCOUNT";
            name_list += "|" + skuPrefix + "DISCOUNT";
            quantity_list += "|0";
            itemvalue_list += "|-" + discountAmountLessTax;
        }

        if (removeOrderLevelTax && taxAmount) {
            sku_list += "|" + skuPrefix + "ORDERTAX";
            quantity_list += "|0";
            itemvalue_list += "|-" + taxAmount;
            name_list += "|" + skuPrefix + "ORDERTAX";
        }

        let land = "";
        let tr = "";
        let rmStore = getCookieValues("rmStore")[0] || "";

        if (!rmStore) {
            data.gtmOnFailure();
            return false;
        }
        const rm_spl = rmStore.split("|");
        for (let p = 0; p < rm_spl.length; p++) {
            if (rm_spl[p].indexOf("ald") > -1) {
                land = rm_spl[p].split(":")[1];
            }
            if (rm_spl[p].indexOf("atrv") > -1) {
                tr = rm_spl[p].split(":")[1];
            }
        }

        let requestUrl = "https://" + domain + "/" + trackingMethod + "?mid=" + merchantID;
        requestUrl += "&ord=" + orderId;
        requestUrl += "&land=" + land;
        requestUrl += "&tr=" + tr;
        requestUrl += "&cur=" + currency;
        requestUrl += "&skulist=" + sku_list;
        requestUrl += "&qlist=" + quantity_list;
        requestUrl += "&amtlist=" + itemvalue_list;
        requestUrl += "&img=1";
        requestUrl += "&spi=3.4.1";

        if (discountAmountLessTax && discountReporting.toLowerCase() === "item") {
            requestUrl += "&discount=" + discountAmountLessTax;
        }

        let optionalData = dl.optionalData || {};

        if (dl.discountCode) {
            optionalData.coupon = dl.discountCode;
        }

        if (dl.customerStatus) {
            optionalData.custstatus = dl.customerStatus;
        }

        if (dl.customerID) {
            optionalData.custid = dl.customerID;
        }

        if (discountAmountLessTax) {
            optionalData.disamt = discountAmountLessTax;
        }

        for (const E in optionalData) {
            if (optionalData.hasOwnProperty(E)) {
                //requestUrl = requestUrl + "&" + enc(E) + "=" + enc(optionalData[E]);
requestUrl = requestUrl + "&" + enc(E).replace('RAN_', '') + "=" + enc(optionalData[E]);              
            }
        }
   
        for (const E in optionalDataLineItems) {
            if (optionalDataLineItems.hasOwnProperty(E)) {
                requestUrl =
                    requestUrl +
                    "&" +
                    enc(E) +
                    "list=" +
                    optionalDataLineItems[E].slice(0, -1);

                if (
                    discountAmountLessTax &&
                    discountReporting.toLowerCase() === "order"
                ) {
                    requestUrl = requestUrl + "|";
                }

                if (taxAmount && removeOrderLevelTax) {
                    requestUrl = requestUrl + "|";
                }
            }
        }
  
        // namelist added at the end as it has lowest importance      
        requestUrl += "&namelist=" + name_list;

        const truncation_limit = 8000;

        if (requestUrl.length > truncation_limit) {
            let n = truncation_limit;

            while (n > 0 && requestUrl.length > truncation_limit) {
                if (requestUrl.charAt(n) == "&") {
                    requestUrl = requestUrl.slice(0, n);
                    break;
                } else {
                    n--;
                }
            }

            requestUrl += "&trunc=true";
        }

        logToConsole(
            "Rakuten Advertising: Performance Tag - RAN Pixel",
            requestUrl
        );

        sendHttpRequest(requestUrl, {
                method: 'GET'
            })
        .then((result) => {
                logToConsole(JSON.stringify({
                    'Name': 'Rakuten Performance Tag',
                    'Type': 'Response',
                    'EventName': 'Conversion',
                    'ResponseStatusCode': result.statusCode,
                    'ResponseHeaders': result.headers,
                    'ResponseBody': result.body,
                }));
                if (result.statusCode >= 200 && result.statusCode < 300) {
                    data.gtmOnSuccess();
                } else {
                    data.gtmOnFailure();
                }
            }
        )
        .catch(() => {
          logToConsole("Failed to make RAN Pixel Request");
          data.gtmOnFailure();
        });
    }
} else if (data.type === "lead") {
    // Lead tag
    // Affiliate config setup
    const affiliateConfig = JSON.parse(getEventData('RAN_lead_affiliate_config')) || '{}';
    // define standard DL variables
    const orderId = getEventData('RAN_transaction_id');
    const currency = getEventData('RAN_currency_code').toUpperCase();
    const conversionType = getEventData('RAN_conversion_type') || "Lead";


    let merchantID = affiliateConfig.ranMID;
    let allowCommission = true;
    if (getEventData('RAN_allow_commission') === false || getEventData('RAN_allow_commission') === "false") {
        data.gtmOnFailure();
        return false;
    }
    let domain = "track.linksynergy.com";
    if (affiliateConfig.domain) {
        domain = affiliateConfig.domain;
    }
    let trackingMethod = "ep";
    if (affiliateConfig.tagType === "mop") {
        trackingMethod = "eventnvppixel";
    }
    let discountReporting = "item";
    if (affiliateConfig.discountType === "order") {
        discountReporting = "order";
    }
    let includeCustomerStatus = false;
    if (affiliateConfig.includeStatus === true) {
        includeCustomerStatus = true;
    }
    let removeOrderLevelTax = false;
    if (affiliateConfig.removeOrderTax === true) {
        removeOrderLevelTax = true;
    }
    let removeTaxFromProducts = true;
    if (affiliateConfig.removeTaxFromProducts === false) {
        removeTaxFromProducts = false;
    }
    let removeTaxFromDiscount = false;
    if (affiliateConfig.removeTaxFromDiscount === true) {
        removeTaxFromDiscount = true;
    }
    let useCentValues = true;
    if (affiliateConfig.centValues === false) {
        useCentValues = false;
    }
    const nonCentCurrencies = "JPY";
    let taxRate = affiliateConfig.taxRate || 0;

    // define line items object
    taxRate = Math.abs(makeNumber(taxRate));
    const taxPercent = (100 + taxRate) / 100;

    let lineitems = [];

    // pre-defined lineitems hard coded values for lead gen and registrations etc.
    let predefinedLineitems = JSON.parse(getEventData('RAN_predefined_products')) || '{}';

    if (predefinedLineitems) {
        lineitems = predefinedLineitems;
    }

    // define rm_trans object
    const dl = {
        orderid: orderId,
        currency: currency,
        conversionType: conversionType,
        lineitems: lineitems,
    };

    // add affiliate config object to rm_trans
    if (affiliateConfig && affiliateConfig.ranMID) {
        dl.affiliateConfig = affiliateConfig;
    }


    if (taxRate) {
        dl.taxRate = taxRate;
    }


    let multiplyBy100 = useCentValues && useCentValues !== "false";
    let isNonCentCurrency = false;
    // determine that currency of the order does not have a cent part (e.g JPY)
    if (currency && nonCentCurrencies) {
        let ncc = (nonCentCurrencies + "").split(",");
        for (let index = 0; index < ncc.length; index++) {
            if (ncc[index] == currency) {
                isNonCentCurrency = true;
                break;
            }
        }
    }

    // this function can be used to ensure any money value is being rounded consistently before output.
    // you should not round anything until it is passed into the final string
    const currencyValueToString = function(val) {
        let out = val;
        // non cent currencies only need to return whole integer values
        if (isNonCentCurrency) {
            out = Math.round(val);
        }
        if (multiplyBy100) {
            out = Math.round(val * 100);
        } else {
            out = Math.round(val * 100) / 100;
        }

        // return a rounded value
        return out.toString();
    };

    if (!dl.orderid && !(dl.lineitems && dl.lineitems.length)) {

        // not enough order data, exit as successfully doing nothing
        data.gtmOnSuccess();
        ///////-----------------------------------------------------------------
        ///////-----------------------------------------------------------------
        ///////---------------------DataLayer is incomplete---------------------
        ///////-----------------------------------------------------------------
        ///////-----------------------------------------------------------------

    } else {
        // have enough order data

        let sku_list = enc(lineitems[0].SKU);
        let quantity_list = lineitems[0].quantity;
        let itemvalue_list = currencyValueToString(Math.round(makeNumber(lineitems[0].unitPrice / taxPercent) * 100) / 100);
        let name_list = enc(lineitems[0].productName);

        let land = "";
        let tr = "";
        let rmStore = getCookieValues("rmStore")[0] || "";

        if (!rmStore) {
            data.gtmOnFailure();
            return false;
        }
        const rm_spl = rmStore.split("|");
        for (let p = 0; p < rm_spl.length; p++) {
            if (rm_spl[p].indexOf("ald") > -1) {
                land = rm_spl[p].split(":")[1];
            }
            if (rm_spl[p].indexOf("atrv") > -1) {
                tr = rm_spl[p].split(":")[1];
            }
        }

        let requestUrl = "https://" + domain + "/" + trackingMethod + "?mid=" + merchantID;

        requestUrl += "&ord=" + orderId;
        requestUrl += "&land=" + land;
        requestUrl += "&tr=" + tr;
        requestUrl += "&cur=" + currency;
        requestUrl += "&skulist=" + sku_list;
        requestUrl += "&qlist=" + quantity_list;
        requestUrl += "&amtlist=" + itemvalue_list;
        requestUrl += "&img=1";
        requestUrl += "&spi=3.4.1";

        // namelist added at the end as it has lowest importance
        requestUrl += "&namelist=" + name_list;

        logToConsole(
            "Rakuten Advertising: Performance Tag - RAN Pixel",
            requestUrl
        );

        sendHttpRequest(requestUrl, {
                method: "GET"
            })
            .then((result) => {
                logToConsole(JSON.stringify({
                    'Name': 'Rakuten Performance Tag',
                    'Type': 'Response',
                    'EventName': 'Lead',
                    'ResponseStatusCode': result.statusCode,
                    'ResponseHeaders': result.headers,
                    'ResponseBody': result.body,
                }));
                if (result.statusCode >= 200 && result.statusCode < 300) {
                    data.gtmOnSuccess();
                } else {
                    data.gtmOnFailure();
                }
            })
            .catch(() => {
                logToConsole("Failed to make RAN Pixel Request");
                data.gtmOnFailure();
            });

    }
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "rmStore"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "rmStore"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://track.linksynergy.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Untitled test 1
  code: |-
    const mockData = {
      // Mocked field values
    };

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();
setup: mock("sendHttpRequest", (url, cb) => { cb(200, {}, {}); });


___NOTES___

Created on 8/24/2022, 10:50:27 AM


